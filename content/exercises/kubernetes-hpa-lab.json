{
  "id": "kubernetes-hpa-lab",
  "title": "Kubernetes Horizontal Pod Autoscaler",
  "description": "Configure and test Horizontal Pod Autoscaler to automatically scale applications based on CPU and memory usage.",
  "category": {
    "name": "Kubernetes",
    "slug": "kubernetes"
  },
  "difficulty": "advanced",
  "estimatedTime": "90 minutes",
  "technologies": ["Kubernetes", "Metrics Server", "kubectl", "YAML"],
  "prerequisites": [
    "Kubernetes cluster access",
    "kubectl configured",
    "Basic Kubernetes knowledge"
  ],
  "learningObjectives": [
    "Configure Horizontal Pod Autoscaler",
    "Understand autoscaling metrics",
    "Implement load testing",
    "Monitor scaling behavior"
  ],
  "environment": "cloud",
  "icon": "Layers",
  "publishedAt": "2024-11-28T14:00:00Z",
  "author": {
    "name": "DevOps Daily Team",
    "slug": "devops-daily-team"
  },
  "tags": ["Kubernetes", "Autoscaling", "Performance", "Monitoring"],
  "steps": [
    {
      "id": "cluster-setup",
      "title": "Verify Cluster Setup and Metrics Server",
      "description": "Ensure your Kubernetes cluster is ready and deploy the metrics server for HPA functionality.",
      "commands": [
        "kubectl cluster-info",
        "kubectl get nodes -o wide",
        "kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml",
        "kubectl get deployment metrics-server -n kube-system",
        "kubectl wait --for=condition=available --timeout=300s deployment/metrics-server -n kube-system"
      ],
      "expectedOutput": "Metrics server deployment should be available and running",
      "hints": [
        "If using minikube, enable metrics-server addon: minikube addons enable metrics-server",
        "Wait for metrics server to be fully ready before proceeding"
      ],
      "validationCriteria": [
        "Cluster is accessible and nodes are ready",
        "Metrics server is deployed and running",
        "kubectl top nodes returns resource usage data"
      ]
    },
    {
      "id": "sample-app",
      "title": "Deploy Sample Application with Resource Limits",
      "description": "Create a resource-defined deployment that will be used for autoscaling demonstration.",
      "codeExample": "# hpa-demo-app.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: php-apache\n  labels:\n    app: php-apache\nspec:\n  selector:\n    matchLabels:\n      run: php-apache\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        run: php-apache\n    spec:\n      containers:\n      - name: php-apache\n        image: registry.k8s.io/hpa-example\n        ports:\n        - containerPort: 80\n        resources:\n          limits:\n            cpu: 500m\n            memory: 256Mi\n          requests:\n            cpu: 200m\n            memory: 128Mi\n        env:\n        - name: TARGET_CPU_UTILIZATION_PERCENTAGE\n          value: \"50\"\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: php-apache\n  labels:\n    run: php-apache\nspec:\n  ports:\n  - port: 80\n    targetPort: 80\n  selector:\n    run: php-apache\n  type: ClusterIP",
      "commands": [
        "kubectl apply -f hpa-demo-app.yaml",
        "kubectl get deployment php-apache",
        "kubectl get pods -l run=php-apache",
        "kubectl get service php-apache"
      ],
      "expectedOutput": "Deployment should be running with 1 replica, service should be created",
      "validationCriteria": [
        "Deployment is running successfully",
        "Pod is in Running status",
        "Service is accessible within cluster",
        "Resource requests and limits are properly set"
      ]
    },
    {
      "id": "create-hpa",
      "title": "Configure Horizontal Pod Autoscaler",
      "description": "Create HPA configuration to automatically scale based on CPU utilization.",
      "codeExample": "# hpa-config.yaml\napiVersion: autoscaling/v2\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: php-apache-hpa\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: php-apache\n  minReplicas: 1\n  maxReplicas: 10\n  metrics:\n  - type: Resource\n    resource:\n      name: cpu\n      target:\n        type: Utilization\n        averageUtilization: 50\n  - type: Resource\n    resource:\n      name: memory\n      target:\n        type: Utilization\n        averageUtilization: 70\n  behavior:\n    scaleDown:\n      stabilizationWindowSeconds: 300\n      policies:\n      - type: Percent\n        value: 10\n        periodSeconds: 60\n    scaleUp:\n      stabilizationWindowSeconds: 0\n      policies:\n      - type: Percent\n        value: 100\n        periodSeconds: 15\n      - type: Pods\n        value: 4\n        periodSeconds: 15\n      selectPolicy: Max",
      "commands": [
        "kubectl apply -f hpa-config.yaml",
        "kubectl get hpa php-apache-hpa",
        "kubectl describe hpa php-apache-hpa"
      ],
      "expectedOutput": "HPA should be created and show current metrics",
      "hints": [
        "Wait a few minutes for HPA to gather initial metrics",
        "Check that metrics server is providing data to HPA"
      ],
      "validationCriteria": [
        "HPA is created successfully",
        "HPA shows current CPU and memory utilization",
        "Target reference is correctly set to php-apache deployment"
      ]
    },
    {
      "id": "load-testing",
      "title": "Generate Load and Test Autoscaling",
      "description": "Create load on the application to trigger horizontal pod autoscaling.",
      "codeExample": "# load-generator.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: load-generator\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: load-generator\n  template:\n    metadata:\n      labels:\n        app: load-generator\n    spec:\n      containers:\n      - name: load-generator\n        image: busybox\n        command:\n        - /bin/sh\n        - -c\n        - |\n          while true; do\n            for i in $(seq 1 100); do\n              wget -q -O- http://php-apache.default.svc.cluster.local/ &\n            done\n            sleep 0.1\n          done\n        resources:\n          requests:\n            cpu: 100m\n            memory: 64Mi",
      "commands": [
        "kubectl apply -f load-generator.yaml",
        "kubectl get pods -l app=load-generator",
        "echo 'Waiting for load to build up...'",
        "sleep 60",
        "kubectl get hpa php-apache-hpa",
        "kubectl top pods -l run=php-apache"
      ],
      "expectedOutput": "CPU utilization should increase and HPA should start scaling up pods",
      "hints": [
        "Monitor HPA status with: kubectl get hpa -w",
        "It may take 2-3 minutes for autoscaling to trigger",
        "Check pod CPU usage with kubectl top pods"
      ],
      "validationCriteria": [
        "Load generator is running",
        "CPU utilization on php-apache pods increases",
        "HPA triggers scale-up event",
        "Number of php-apache replicas increases"
      ]
    },
    {
      "id": "monitor-scaling",
      "title": "Monitor and Analyze Scaling Behavior",
      "description": "Observe the autoscaling behavior and analyze the scaling events.",
      "commands": [
        "kubectl get hpa php-apache-hpa -w &",
        "watch 'kubectl get pods -l run=php-apache'",
        "kubectl describe hpa php-apache-hpa",
        "kubectl get events --sort-by='.lastTimestamp' | grep -i horizontal"
      ],
      "expectedOutput": "Multiple php-apache pods should be running, HPA events should show scaling decisions",
      "hints": [
        "Watch the REPLICAS column in HPA output",
        "Check events for scaling decisions",
        "Use 'kubectl top pods' to see resource usage"
      ],
      "validationCriteria": [
        "HPA successfully scales up to multiple replicas",
        "Scaling events are visible in cluster events",
        "Load is distributed across multiple pods",
        "CPU utilization stabilizes around target percentage"
      ]
    },
    {
      "id": "scale-down-test",
      "title": "Test Scale-Down Behavior",
      "description": "Remove load and observe how HPA scales down the application.",
      "commands": [
        "kubectl delete deployment load-generator",
        "echo 'Load removed, waiting for scale-down...'",
        "sleep 300",
        "kubectl get hpa php-apache-hpa",
        "kubectl get pods -l run=php-apache",
        "kubectl describe hpa php-apache-hpa"
      ],
      "expectedOutput": "HPA should gradually scale down pods as CPU utilization decreases",
      "hints": [
        "Scale-down takes longer than scale-up (default 5 minutes)",
        "Monitor with: kubectl get hpa -w",
        "Check stabilization window settings in HPA config"
      ],
      "validationCriteria": [
        "Load generator is removed",
        "CPU utilization decreases below target",
        "HPA triggers scale-down events",
        "Pod count returns to minimum replicas"
      ]
    }
  ],
  "completionCriteria": [
    "HPA successfully scales pods up under load",
    "HPA scales pods down when load decreases",
    "Metrics are properly collected and displayed",
    "Load testing demonstrates autoscaling behavior"
  ],
  "resources": [
    {
      "title": "Kubernetes HPA Documentation",
      "url": "https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/",
      "type": "documentation",
      "external": true
    }
  ]
}
